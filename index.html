<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Venta +</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 320px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #0052ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #dashboard { display: none; width: 90%; max-width: 600px; background: white; padding: 20px; border-radius: 12px; }
    </style>
</head>
<body>

    <div id="login-card" class="card">
        <h2>Mi Venta +</h2>
        <p>Ingresa para administrar</p>
        <input type="email" id="email" placeholder="tu@email.com">
        <button onclick="enviarCodigo()">Enviar Enlace Mágico</button>
    </div>

    <div id="dashboard">
        <h2>Bienvenido al Panel</h2>
        <p>¡Has ingresado con éxito!</p>
        <hr>
        <input type="text" id="p-nome" placeholder="Producto">
        <input type="number" id="p-preco" placeholder="Precio">
        <button onclick="salvar()">Guardar</button>
        <br><br>
        <button onclick="firebase.auth().signOut()" style="background:#ff4d4d">Cerrar Sesión</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDBntAU1uA5zGGZRW3c0Olxn_fe7-D0EFM",
            authDomain: "miguarani.firebaseapp.com",
            projectId: "miguarani",
            storageBucket: "miguarani.firebasestorage.app",
            messagingSenderId: "526507667874",
            appId: "1:526507667874:web:b5b08c890c832d5f2702fb"
        };
        firebase.initializeApp(firebaseConfig);

        // 1. Monitor de sessão
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-card').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            } else {
                document.getElementById('login-card').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        // 2. Enviar o link
        function enviarCodigo() {
            const email = document.getElementById('email').value;
            const actionCodeSettings = {
                url: window.location.href, // Garante que volta para a mesma página
                handleCodeInApp: true
            };

            firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    window.localStorage.setItem('emailForSignIn', email);
                    alert('¡Revisa tu email!');
                })
                .catch(err => alert(err.message));
        }

        // 3. Finalizar o acesso (O QUE QUEBRA O LOOP)
        if (firebase.auth().isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn');
            
            // Se o e-mail sumiu do navegador, pergunta de novo
            if (!email) {
                email = window.prompt('Por favor confirma tu email para entrar:');
            }

            if (email) {
                firebase.auth().signInWithEmailLink(email, window.location.href)
                    .then(() => {
                        window.localStorage.removeItem('emailForSignIn');
                        // Força o redirecionamento para limpar o link sujo na barra de endereços
                        window.location.replace(window.location.pathname);
                    })
                    .catch(err => alert('Error: ' + err.message));
            }
        }
    </script>
</body>
</html>